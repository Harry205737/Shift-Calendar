<script>
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    const currentDay = today.getDate();
    let selectedDate = null;
    let addNoteMode = false;
    let addShiftMode = false;

    let shiftTypes = JSON.parse(localStorage.getItem('shiftTypes')) || { off: '#ffffff' };
    populateShiftDropdown();

    function populateShiftDropdown() {
        const shiftDropdown = document.getElementById('shift');
        shiftDropdown.innerHTML = '';

        for (const [shiftName, color] of Object.entries(shiftTypes)) {
            const option = document.createElement('option');
            option.value = shiftName;
            option.innerText = shiftName;
            option.style.backgroundColor = color;
            shiftDropdown.appendChild(option);
        }
    }

    function addShiftType() {
        const shiftName = document.getElementById('shift-name').value.trim();
        const shiftColor = document.getElementById('shift-color').value;

        if (shiftName === '' || shiftTypes[shiftName]) {
            alert("Shift name cannot be empty or duplicate.");
            return;
        }

        shiftTypes[shiftName] = shiftColor;
        localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));
        populateShiftDropdown();
        document.getElementById('shift-name').value = ''; 
    }

    function enterAddShiftMode() {
        addShiftMode = true;
        addNoteMode = false;
        alert("Click on a day to add the selected shift.");
    }

    function enterAddNoteMode() {
        addNoteMode = true;
        addShiftMode = false;
        alert("Click on a day to add a note.");
    }

    function generateCalendar(year) {
        const calendarContainer = document.getElementById('calendar');
        calendarContainer.innerHTML = '';

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        for (let yearIndex = year; yearIndex <= 2030; yearIndex++) {
            for (let month = 0; month < 12; month++) {
                const date = new Date(yearIndex, month, 1);
                const daysInMonth = new Date(yearIndex, month + 1, 0).getDate();
                const startDay = date.getDay();

                const monthDiv = document.createElement('div');
                monthDiv.classList.add('month');
                monthDiv.innerHTML = `<h2 id="month-${yearIndex}-${month}">${monthNames[month]} ${yearIndex}</h2>`;

                const table = document.createElement('table');
                const headerRow = document.createElement('tr');
                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                daysOfWeek.forEach(day => {
                    const th = document.createElement('th');
                    th.innerText = day;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                let row = document.createElement('tr');
                for (let i = 0; i < startDay; i++) {
                    row.appendChild(document.createElement('td'));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const td = document.createElement('td');
                    td.innerText = day;

                    if (yearIndex === currentYear && month === currentMonth && day === currentDay) {
                        td.classList.add('current-day');
                    }

                    td.onclick = () => {
                        if (addShiftMode) {
                            td.style.backgroundColor = shiftTypes[document.getElementById('shift').value];
                        } else if (addNoteMode) {
                            showNoteDialog(yearIndex, month, day);
                        }
                    };

                    row.appendChild(td);

                    if ((startDay + day) % 7 === 0) {
                        table.appendChild(row);
                        row = document.createElement('tr');
                    }
                }

                if (row.childNodes.length > 0) {
                    table.appendChild(row);
                }

                monthDiv.appendChild(table);
                calendarContainer.appendChild(monthDiv);
            }
        }
    }

    function showNoteDialog(year, month, day) {
        selectedDate = { year, month, day };
        document.getElementById('note-dialog-date').innerText = `${day}/${month + 1}/${year}`;
        document.getElementById('note-text').value = '';
        document.getElementById('shift-start').value = '';
        document.getElementById('shift-end').value = '';
        document.getElementById('note-dialog').style.display = 'block';
    }

    function saveNote() {
        const noteText = document.getElementById('note-text').value;
        const shiftStart = document.getElementById('shift-start').value;
        const shiftEnd = document.getElementById('shift-end').value;

        const noteKey = `${selectedDate.year}-${selectedDate.month}-${selectedDate.day}`;
        localStorage.setItem(noteKey, JSON.stringify({ noteText, shiftStart, shiftEnd }));

        closeNoteDialog();
    }

    function closeNoteDialog() {
        document.getElementById('note-dialog').style.display = 'none';
    }

    function goToCurrentMonth() {
        const currentMonthDiv = document.getElementById(`month-${currentYear}-${currentMonth}`);
        if (currentMonthDiv) {
            window.scrollTo({
                top: currentMonthDiv.offsetTop - 50,
                behavior: 'smooth'
            });
        }
    }

    function toggleMenu() {
        const menuContent = document.querySelector('.menu-content');
        menuContent.style.display = menuContent.style.display === 'none' ? 'flex' : 'none';
    }

    generateCalendar(currentYear);
</script>
